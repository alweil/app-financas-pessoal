<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessor Financeiro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .card-title {
            font-weight: 600;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .badge {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge.success { background: #27ae60; }
        .badge.warning { background: #f39c12; }
        .badge.danger { background: #e74c3c; }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .value {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .amount {
            font-size: 20px;
            font-weight: 700;
            color: #e74c3c;
        }
        
        .amount.income {
            color: #27ae60;
        }
        
        .transaction {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .merchant {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .date {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .notice {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .notice.success {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .notice.info {
            background: #e3f2fd;
            color: #0d47a1;
        }

        .notice.error {
            background: #fee;
            color: #c33;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }
        
        .btn-success {
            background: #27ae60;
        }

        .btn-secondary {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
        }
        
        .account-card {
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .account-card:hover {
            transform: translateX(4px);
        }
        
        .back-btn {
            background: none;
            border: none;
            color: #3498db;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .input,
        .select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .helper {
            font-size: 12px;
            color: #7f8c8d;
        }

        .actions-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <h1>‚òï Assessor Financeiro</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="showTab('accounts')">Contas</div>
        <div class="tab" onclick="showTab('transactions')">Todas Transa√ß√µes</div>
        <div class="tab" onclick="showTab('sync')">Sincronizar</div>
    </div>
    
    <div id="error"></div>
    <div id="status"></div>
    
    <!-- Contas -->
    <div id="accounts-section" class="section active">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Criar Usuario</span>
            </div>
            <div class="field">
                <label class="label" for="register-email">Email</label>
                <input id="register-email" class="input" type="email" placeholder="user@example.com" />
            </div>
            <div class="field">
                <label class="label" for="register-password">Senha</label>
                <input id="register-password" class="input" type="password" placeholder="Crie uma senha" />
            </div>
            <button class="btn btn-success" onclick="registerUser()">Criar Usuario</button>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Login</span>
            </div>
            <div class="field">
                <label class="label" for="login-email">Email</label>
                <input id="login-email" class="input" type="email" placeholder="user@example.com" />
            </div>
            <div class="field">
                <label class="label" for="login-password">Senha</label>
                <input id="login-password" class="input" type="password" placeholder="Digite sua senha" />
            </div>
            <button class="btn btn-success" onclick="login()">Entrar</button>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Autenticacao</span>
            </div>
            <div class="field">
                <label class="label" for="token-input">Token (Bearer)</label>
                <input id="token-input" class="input" type="password" placeholder="Cole o access_token" />
                <div class="helper">Usado para listar e criar contas. Salvo localmente no navegador.</div>
            </div>
            <div class="info-row">
                <span class="label">Usuario logado</span>
                <span class="value" id="current-user-email">-</span>
            </div>
            <button class="btn btn-secondary" onclick="logout()">Limpar Token</button>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Nova Conta</span>
            </div>
            <div class="field">
                <label class="label" for="bank-name">Banco</label>
                <input id="bank-name" class="input" type="text" placeholder="Ex: Nubank" />
            </div>
            <div class="field">
                <label class="label" for="account-type">Tipo</label>
                <select id="account-type" class="select">
                    <option value="checking">Conta Corrente</option>
                    <option value="savings">Poupanca</option>
                    <option value="credit_card">Cartao Credito</option>
                    <option value="investment">Investimento</option>
                </select>
            </div>
            <div class="field">
                <label class="label" for="nickname">Apelido (opcional)</label>
                <input id="nickname" class="input" type="text" placeholder="Ex: Cartao roxo" />
            </div>
            <button class="btn btn-success" onclick="createAccount()">‚ûï Criar Conta</button>
        </div>

        <div id="accounts-list">
            <div class="loading">Carregando contas...</div>
        </div>
        <button class="btn" onclick="fetchAccounts()">üîÑ Atualizar</button>
    </div>
    
    <!-- Transa√ß√µes -->
    <div id="transactions-section" class="section">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Filtros</span>
            </div>
            <div class="field">
                <label class="label" for="transactions-filter-account-id">Conta</label>
                <select id="transactions-filter-account-id" class="select">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="field">
                <label class="label" for="transactions-filter-start">Data inicial</label>
                <input id="transactions-filter-start" class="input" type="date" />
            </div>
            <div class="field">
                <label class="label" for="transactions-filter-end">Data final</label>
                <input id="transactions-filter-end" class="input" type="date" />
            </div>
            <div class="actions-row">
                <button class="btn btn-small btn-success" onclick="applyTransactionFilters()">Aplicar</button>
                <button class="btn btn-small btn-secondary" onclick="clearTransactionFilters()">Limpar</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title" id="transaction-form-title">Nova Transacao</span>
            </div>
            <div class="field">
                <label class="label" for="transaction-account-id">Conta</label>
                <select id="transaction-account-id" class="select">
                    <option value="">Selecione</option>
                </select>
            </div>
            <div class="field">
                <label class="label" for="transaction-amount">Valor</label>
                <input id="transaction-amount" class="input" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div class="field">
                <label class="label" for="transaction-merchant">Estabelecimento</label>
                <input id="transaction-merchant" class="input" type="text" placeholder="Ex: Mercado" />
            </div>
            <div class="field">
                <label class="label" for="transaction-description">Descricao</label>
                <input id="transaction-description" class="input" type="text" placeholder="Opcional" />
            </div>
            <div class="field">
                <label class="label" for="transaction-date">Data</label>
                <input id="transaction-date" class="input" type="datetime-local" />
            </div>
            <div class="field">
                <label class="label" for="transaction-type">Tipo</label>
                <select id="transaction-type" class="select">
                    <option value="">Selecione</option>
                    <option value="purchase">Compra</option>
                    <option value="pix_in">Pix Entrada</option>
                    <option value="pix_out">Pix Saida</option>
                    <option value="unknown">Desconhecido</option>
                </select>
            </div>
            <div class="field">
                <label class="label" for="transaction-method">Pagamento</label>
                <select id="transaction-method" class="select">
                    <option value="">Selecione</option>
                    <option value="credit_card">Cartao Credito</option>
                    <option value="debit_card">Cartao Debito</option>
                    <option value="pix">Pix</option>
                    <option value="boleto">Boleto</option>
                </select>
            </div>
            <div class="actions-row">
                <button class="btn btn-small btn-success" onclick="saveTransaction()">Salvar</button>
                <button class="btn btn-small btn-secondary" onclick="cancelTransactionEdit()">Cancelar</button>
            </div>
        </div>

        <div id="transactions-list">
            <div class="loading">Carregando transa√ß√µes...</div>
        </div>
        <button class="btn" onclick="fetchTransactions()">üîÑ Atualizar</button>
    </div>
    
    <!-- Sincronizar -->
    <div id="sync-section" class="section">
        <div class="card">
            <h3>Sincronizar com Gmail</h3>
            <p style="margin: 12px 0; color: #666;">
                Busca emails dos bancos e cria transa√ß√µes automaticamente.
            </p>
            <div class="field">
                <label class="label" for="sync-account-id">Conta</label>
                <select id="sync-account-id" class="select">
                    <option value="">Carregando contas...</option>
                </select>
            </div>
            <div id="sync-result"></div>
            <button class="btn btn-success" onclick="syncGmail()">
                üìß Sincronizar Agora
            </button>
        </div>
    </div>
    
    <!-- Detalhes da Conta -->
    <div id="account-detail-section" class="section">
        <button class="back-btn" onclick="showTab('accounts')">
            ‚Üê Voltar
        </button>
        <div id="account-detail"></div>
        <div id="account-transactions"></div>
    </div>

    <script>
        const API_URL = '';
        const state = {
            accounts: [],
            transactions: [],
            editingTransactionId: null,
            editingAccountId: null
        };

        function getToken() {
            const tokenInput = document.getElementById('token-input');
            const token = (tokenInput && tokenInput.value || '').trim();
            return token;
        }

        function getAuthHeaders() {
            const token = getToken();
            if (!token) return {};
            return { 'Authorization': `Bearer ${token}` };
        }

        function persistToken() {
            const token = getToken();
            if (token) {
                localStorage.setItem('access_token', token);
            } else {
                localStorage.removeItem('access_token');
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-section').classList.add('active');
            
            if (tabName === 'accounts') fetchAccounts();
            if (tabName === 'transactions') fetchTransactions();
        }
        
        function showError(msg) {
            document.getElementById('error').innerHTML = 
                '<div class="error">‚ùå ' + msg + '</div>';
        }
        
        function clearError() {
            document.getElementById('error').innerHTML = '';
        }

        function setStatus(message, type) {
            const status = document.getElementById('status');
            const kind = type || 'info';
            status.innerHTML = `<div class="notice ${kind}">${message}</div>`;
        }

        function clearStatus() {
            document.getElementById('status').innerHTML = '';
        }

        function setCurrentUser(email) {
            const el = document.getElementById('current-user-email');
            el.textContent = email || '-';
        }
        
        async function fetchAccounts() {
            clearError();
            try {
                const res = await fetch(API_URL + '/accounts/', {
                    headers: {
                        ...getAuthHeaders()
                    }
                });
                if (!res.ok) throw new Error('Erro ao carregar contas');
                const data = await res.json();
                const accounts = data.items || [];
                state.accounts = accounts;
                renderAccounts(accounts);
                updateSyncAccounts(accounts);
                updateTransactionAccountOptions(accounts);
            } catch (e) {
                showError(e.message);
            }
        }
        
        function renderAccounts(accounts) {
            if (accounts.length === 0) {
                document.getElementById('accounts-list').innerHTML = `
                    <div class="empty-state">
                        <p>Nenhuma conta cadastrada</p>
                        <p style="font-size: 14px; margin-top: 8px;">
                            Use o formulario acima para criar sua primeira conta
                        </p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('accounts-list').innerHTML = accounts.map(acc => `
                <div class="card account-card" onclick="showAccountDetail(${acc.id})">
                    <div class="card-header">
                        <span class="card-title">${acc.bank_name}</span>
                        <span class="badge">${getAccountTypeLabel(acc.account_type)}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Apelido</span>
                        <span class="value">${acc.nickname || '-'}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">√öltimo Saldo</span>
                        <span class="value">${acc.last_balance ? 'R$ ' + acc.last_balance.toFixed(2) : '-'}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function getAccountTypeLabel(type) {
            const labels = {
                'checking': 'Conta Corrente',
                'savings': 'Poupan√ßa',
                'credit_card': 'Cart√£o Cr√©dito',
                'investment': 'Investimento'
            };
            return labels[type] || type;
        }
        
        async function showAccountDetail(accountId) {
            clearError();
            try {
                const [accountRes, transactionsRes] = await Promise.all([
                    fetch(API_URL + `/accounts/${accountId}`, {
                        headers: {
                            ...getAuthHeaders()
                        }
                    }),
                    fetch(API_URL + `/transactions/?account_id=${accountId}`, {
                        headers: {
                            ...getAuthHeaders()
                        }
                    })
                ]);
                
                const account = await accountRes.json();
                const transactionsData = await transactionsRes.json();
                const transactions = transactionsData.items || [];
                state.editingAccountId = account.id;
                
                document.getElementById('account-detail').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${account.bank_name}</span>
                            <span class="badge">${getAccountTypeLabel(account.account_type)}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Apelido</span>
                            <span class="value">${account.nickname || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">√öltimo Saldo</span>
                            <span class="value">${account.last_balance ? 'R$ ' + account.last_balance.toFixed(2) : '-'}</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Editar Conta</span>
                        </div>
                        <div class="field">
                            <label class="label" for="account-edit-bank-name">Banco</label>
                            <input id="account-edit-bank-name" class="input" type="text" value="${account.bank_name}" />
                        </div>
                        <div class="field">
                            <label class="label" for="account-edit-type">Tipo</label>
                            <select id="account-edit-type" class="select">
                                <option value="checking" ${account.account_type === 'checking' ? 'selected' : ''}>Conta Corrente</option>
                                <option value="savings" ${account.account_type === 'savings' ? 'selected' : ''}>Poupanca</option>
                                <option value="credit_card" ${account.account_type === 'credit_card' ? 'selected' : ''}>Cartao Credito</option>
                                <option value="investment" ${account.account_type === 'investment' ? 'selected' : ''}>Investimento</option>
                            </select>
                        </div>
                        <div class="field">
                            <label class="label" for="account-edit-nickname">Apelido</label>
                            <input id="account-edit-nickname" class="input" type="text" value="${account.nickname || ''}" />
                        </div>
                        <div class="actions-row">
                            <button class="btn btn-small btn-success" onclick="saveAccount()">Salvar</button>
                            <button class="btn btn-small btn-danger" onclick="deleteAccount()">Excluir</button>
                        </div>
                    </div>
                `;
                
                renderTransactions(transactions, 'account-transactions');
                
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('account-detail-section').classList.add('active');
            } catch (e) {
                showError(e.message);
            }
        }
        
        async function fetchTransactions() {
            clearError();
            try {
                const params = new URLSearchParams();
                const accountId = document.getElementById('transactions-filter-account-id').value;
                const startDate = document.getElementById('transactions-filter-start').value;
                const endDate = document.getElementById('transactions-filter-end').value;

                if (accountId) params.set('account_id', accountId);
                if (startDate) params.set('start_date', new Date(startDate).toISOString());
                if (endDate) params.set('end_date', new Date(endDate).toISOString());

                const url = params.toString()
                    ? `${API_URL}/transactions/?${params.toString()}`
                    : API_URL + '/transactions/';

                const res = await fetch(url, {
                    headers: {
                        ...getAuthHeaders()
                    }
                });
                if (!res.ok) throw new Error('Erro ao carregar transa√ß√µes');
                const data = await res.json();
                const transactions = data.items || [];
                renderTransactions(transactions, 'transactions-list');
            } catch (e) {
                showError(e.message);
            }
        }
        
        function renderTransactions(transactions, elementId) {
            if (transactions.length === 0) {
                state.transactions = [];
                document.getElementById(elementId).innerHTML = `
                    <div class="empty-state">
                        <p>Nenhuma transa√ß√£o encontrada</p>
                    </div>
                `;
                return;
            }

            state.transactions = transactions;
            
            const total = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            
            document.getElementById(elementId).innerHTML = `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="info-row" style="border-bottom: none;">
                        <span class="label">Total em Transa√ß√µes</span>
                        <span class="amount">R$ ${total.toFixed(2)}</span>
                    </div>
                </div>
                ${transactions.map(t => `
                    <div class="transaction">
                        <div class="transaction-header">
                            <div>
                                <div class="merchant">${t.merchant || t.description || 'Transa√ß√£o'}</div>
                                <div class="date">${formatDate(t.transaction_date)}</div>
                            </div>
                            <span class="amount">R$ ${(t.amount || 0).toFixed(2)}</span>
                        </div>
                        <div class="actions-row" style="margin-top: 8px;">
                            <button class="btn btn-small btn-secondary" onclick="startTransactionEdit(${t.id})">Editar</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTransaction(${t.id})">Excluir</button>
                        </div>
                        ${t.installments_total ? `
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                Parcela ${t.installments_current}/${t.installments_total}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR');
        }

        function updateSyncAccounts(accounts) {
            const select = document.getElementById('sync-account-id');
            if (!select) return;

            if (!accounts || accounts.length === 0) {
                select.innerHTML = '<option value="">Sem contas</option>';
                return;
            }

            const currentValue = select.value;
            select.innerHTML = accounts.map(acc => {
                const label = acc.nickname ? `${acc.bank_name} (${acc.nickname})` : acc.bank_name;
                return `<option value="${acc.id}">${label}</option>`;
            }).join('');

            if (currentValue && accounts.some(acc => String(acc.id) === String(currentValue))) {
                select.value = currentValue;
            }
        }

        function updateTransactionAccountOptions(accounts) {
            const selects = [
                document.getElementById('transaction-account-id'),
                document.getElementById('transactions-filter-account-id')
            ];

            selects.forEach((select, index) => {
                if (!select) return;

                const currentValue = select.value;
                const options = [index === 1 ? '<option value="">Todas</option>' : '<option value="">Selecione</option>'];

                accounts.forEach(acc => {
                    const label = acc.nickname ? `${acc.bank_name} (${acc.nickname})` : acc.bank_name;
                    options.push(`<option value="${acc.id}">${label}</option>`);
                });

                select.innerHTML = options.join('');

                if (currentValue && accounts.some(acc => String(acc.id) === String(currentValue))) {
                    select.value = currentValue;
                }
            });
        }

        async function loginWithCredentials(email, password) {
            const body = new URLSearchParams();
            body.set('username', email);
            body.set('password', password);

            const res = await fetch(API_URL + '/auth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString()
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || 'Erro ao autenticar');
            }

            const data = await res.json();
            document.getElementById('token-input').value = data.access_token || '';
            persistToken();
        }

        async function fetchCurrentUser() {
            const token = getToken();
            if (!token) {
                setCurrentUser('-');
                return;
            }

            try {
                const res = await fetch(API_URL + '/auth/me', {
                    headers: {
                        ...getAuthHeaders()
                    }
                });

                if (!res.ok) {
                    setCurrentUser('-');
                    return;
                }

                const data = await res.json();
                setCurrentUser(data.email || '-');
            } catch (e) {
                setCurrentUser('-');
            }
        }

        async function login() {
            clearError();
            clearStatus();
            try {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                if (!email || !password) {
                    showError('Informe email e senha');
                    return;
                }

                await loginWithCredentials(email, password);
                setStatus('Login realizado com sucesso.', 'success');
                document.getElementById('login-password').value = '';
                await fetchCurrentUser();
                await fetchAccounts();
            } catch (e) {
                showError(e.message);
            }
        }

        async function registerUser() {
            clearError();
            clearStatus();
            try {
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;

                if (!email || !password) {
                    showError('Informe email e senha');
                    return;
                }

                const res = await fetch(API_URL + '/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Erro ao criar usuario');
                }

                document.getElementById('register-password').value = '';
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = password;

                await login();
                setStatus('Usuario criado e autenticado.', 'success');
            } catch (e) {
                showError(e.message);
            }
        }

        function logout() {
            clearError();
            clearStatus();
            document.getElementById('token-input').value = '';
            persistToken();
            setCurrentUser('-');
            setStatus('Token removido.', 'info');
            state.accounts = [];
            updateSyncAccounts([]);
            updateTransactionAccountOptions([]);
            document.getElementById('accounts-list').innerHTML = `
                <div class="empty-state">
                    <p>Informe o token para carregar contas</p>
                </div>
            `;
        }
        
        async function syncGmail() {
            clearError();
            clearStatus();
            document.getElementById('sync-result').innerHTML = 
                '<div class="loading">Sincronizando...</div>';
            
            try {
                const accountId = document.getElementById('sync-account-id').value;
                if (!accountId) {
                    throw new Error('Selecione uma conta para sincronizar');
                }

                const res = await fetch(API_URL + `/gmail/sync?account_id=${accountId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Erro ao sincronizar');
                }
                
                const result = await res.json();
                
                document.getElementById('sync-result').innerHTML = `
                    <div class="card" style="background: #e8f5e9; border: 1px solid #4caf50;">
                        <div class="info-row">
                            <span class="label">Emails Encontrados</span>
                            <span class="value">${result.messages_found}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Emails Parseados</span>
                            <span class="value">${result.messages_parsed}</span>
                        </div>
                        <div class="info-row" style="border-bottom: none;">
                            <span class="label">Transa√ß√µes Criadas</span>
                            <span class="value" style="color: #27ae60; font-weight: 700;">${result.transactions_created}</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('sync-result').innerHTML = 
                    '<div class="error">‚ùå ' + e.message + '</div>';
            }
        }

        async function createAccount() {
            clearError();
            clearStatus();
            try {
                const bankName = document.getElementById('bank-name').value.trim();
                const accountType = document.getElementById('account-type').value;
                const nickname = document.getElementById('nickname').value.trim();

                if (!bankName) {
                    showError('Informe o nome do banco');
                    return;
                }

                const res = await fetch(API_URL + '/accounts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        bank_name: bankName,
                        account_type: accountType,
                        nickname: nickname || null
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Erro ao criar conta');
                }

                document.getElementById('bank-name').value = '';
                document.getElementById('nickname').value = '';
                setStatus('Conta criada com sucesso.', 'success');
                await fetchAccounts();
            } catch (e) {
                showError(e.message);
            }
        }

        async function saveAccount() {
            clearError();
            clearStatus();
            if (!state.editingAccountId) {
                showError('Nenhuma conta selecionada');
                return;
            }

            try {
                const bankName = document.getElementById('account-edit-bank-name').value.trim();
                const accountType = document.getElementById('account-edit-type').value;
                const nickname = document.getElementById('account-edit-nickname').value.trim();

                const res = await fetch(API_URL + `/accounts/${state.editingAccountId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        bank_name: bankName,
                        account_type: accountType,
                        nickname: nickname || null
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Erro ao atualizar conta');
                }

                setStatus('Conta atualizada.', 'success');
                await fetchAccounts();
                await showAccountDetail(state.editingAccountId);
            } catch (e) {
                showError(e.message);
            }
        }

        async function deleteAccount() {
            clearError();
            clearStatus();
            if (!state.editingAccountId) {
                showError('Nenhuma conta selecionada');
                return;
            }

            const confirmed = confirm('Excluir esta conta? Esta acao nao pode ser desfeita.');
            if (!confirmed) return;

            try {
                const res = await fetch(API_URL + `/accounts/${state.editingAccountId}`, {
                    method: 'DELETE',
                    headers: {
                        ...getAuthHeaders()
                    }
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Erro ao excluir conta');
                }

                setStatus('Conta excluida.', 'success');
                state.editingAccountId = null;
                showTab('accounts');
                await fetchAccounts();
            } catch (e) {
                showError(e.message);
            }
        }

        function applyTransactionFilters() {
            fetchTransactions();
        }

        function clearTransactionFilters() {
            document.getElementById('transactions-filter-account-id').value = '';
            document.getElementById('transactions-filter-start').value = '';
            document.getElementById('transactions-filter-end').value = '';
            fetchTransactions();
        }

        function fillTransactionForm(transaction) {
            document.getElementById('transaction-account-id').value = transaction.account_id || '';
            document.getElementById('transaction-amount').value = transaction.amount || '';
            document.getElementById('transaction-merchant').value = transaction.merchant || '';
            document.getElementById('transaction-description').value = transaction.description || '';
            document.getElementById('transaction-date').value = transaction.transaction_date
                ? new Date(transaction.transaction_date).toISOString().slice(0, 16)
                : '';
            document.getElementById('transaction-type').value = transaction.transaction_type || '';
            document.getElementById('transaction-method').value = transaction.payment_method || '';
        }

        function resetTransactionForm() {
            document.getElementById('transaction-account-id').value = '';
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-merchant').value = '';
            document.getElementById('transaction-description').value = '';
            document.getElementById('transaction-date').value = '';
            document.getElementById('transaction-type').value = '';
            document.getElementById('transaction-method').value = '';
        }

        function startTransactionEdit(transactionId) {
            const transaction = state.transactions.find(item => item.id === transactionId);
            if (!transaction) {
                showError('Transacao nao encontrada');
                return;
            }

            state.editingTransactionId = transaction.id;
            document.getElementById('transaction-form-title').textContent = 'Editar Transacao';
            fillTransactionForm(transaction);
            setStatus('Edicao de transacao ativa.', 'info');
        }

        function cancelTransactionEdit() {
            state.editingTransactionId = null;
            document.getElementById('transaction-form-title').textContent = 'Nova Transacao';
            resetTransactionForm();
            setStatus('Edicao cancelada.', 'info');
        }

        async function saveTransaction() {
            clearError();
            clearStatus();

            try {
                const accountId = document.getElementById('transaction-account-id').value;
                const amount = document.getElementById('transaction-amount').value;

                if (!accountId || !amount) {
                    showError('Informe conta e valor');
                    return;
                }

                const payload = {
                    account_id: Number(accountId),
                    amount: Number(amount),
                    merchant: document.getElementById('transaction-merchant').value.trim() || null,
                    description: document.getElementById('transaction-description').value.trim() || null,
                    transaction_date: document.getElementById('transaction-date').value
                        ? new Date(document.getElementById('transaction-date').value).toISOString()
                        : null,
                    transaction_type: document.getElementById('transaction-type').value || null,
                    payment_method: document.getElementById('transaction-method').value || null
                };

                const isEdit = Boolean(state.editingTransactionId);
                const url = isEdit
                    ? `${API_URL}/transactions/${state.editingTransactionId}`
                    : `${API_URL}/transactions/`;
                const method = isEdit ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Erro ao salvar transacao');
                }

                setStatus(isEdit ? 'Transacao atualizada.' : 'Transacao criada.', 'success');
                cancelTransactionEdit();
                await fetchTransactions();
            } catch (e) {
                showError(e.message);
            }
        }

        async function deleteTransaction(transactionId) {
            clearError();
            clearStatus();
            const confirmed = confirm('Excluir esta transacao?');
            if (!confirmed) return;

            try {
                const res = await fetch(API_URL + `/transactions/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        ...getAuthHeaders()
                    }
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Erro ao excluir transacao');
                }

                setStatus('Transacao excluida.', 'success');
                if (state.editingTransactionId === transactionId) {
                    cancelTransactionEdit();
                }
                await fetchTransactions();
            } catch (e) {
                showError(e.message);
            }
        }
        
        // Carregar dados iniciais
        const savedToken = localStorage.getItem('access_token');
        if (savedToken) {
            document.getElementById('token-input').value = savedToken;
        }
        document.getElementById('token-input').addEventListener('input', persistToken);
        document.getElementById('token-input').addEventListener('change', fetchCurrentUser);
        fetchCurrentUser();
        fetchAccounts();
    </script>
</body>
</html>
